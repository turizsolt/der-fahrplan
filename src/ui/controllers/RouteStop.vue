<template>
  <div class="stop">
    <div
      class="stop-circle"
      :style="{
        backgroundColor: stop.shouldStop ? stop.stationRgbColor : 'transparent',
      }"
      @click.stop="$emit('shouldStop')"
    ></div>
    <div v-if="index !== route.stops.length - 1" class="stop-after color"></div>
    <div
      v-if="index === route.stops.length - 1"
      class="stop-after nocolor"
    ></div>
    <div
      class="stop-name"
      :style="{
        color:
          stop.isServed || !stop.isStation || !stop.shouldStop
            ? 'grey'
            : 'black',
        fontStyle: stop.isStation ? 'normal' : 'italic',
      }"
    >
      {{ stop.atStation ? "* " : "" }} {{ stop.stationName }}
      {{ stop.isArrivalStation ? "Ã©." : "" }}
      <!--<span @click="addTime()">+</span>/<span @click="removeTime()">-</span>-->
    </div>

    <!-- buttons 
    <div class="stop-button-holder">
      <div
        v-if="candelete"
        class="stop-button"
        :class="stop.isReverseStop ? 'stop-reverse' : 'stop-non-reverse'"
        @click.stop="$emit('reverse')"
      >
        R
      </div>
      <div
        v-if="candelete"
        class="stop-button stop-delete"
        @click.stop="$emit('delete')"
      >
        x
      </div>
    </div>
    -->

    <!-- platform -->
    <select
      v-if="!isTrip"
      size="1"
      class="stop-select-platform"
      :value="stop.platform"
      @change="changePlatform"
    >
      <option value="">?</option>
      <option
        v-for="(option, index) in stop.platformOptions"
        :value="option.id"
        :key="index"
      >
        {{ option.no }}
      </option>
    </select>

    <!-- arrival departure -->
    <input
      v-if="!isTrip && !stop.isDepartureStation"
      class="stop-input-time"
      type="text"
      v-model="arrivalTime"
      @keyup.stop="handleTime('arrivalTime', $event)"
    />
    <div v-if="!isTrip && stop.isDepartureStation" class="stop-input-time">
      -
    </div>
    <input
      v-if="!isTrip && !stop.isArrivalStation"
      class="stop-input-time"
      type="text"
      v-model="departureTime"
      @keyup.stop="handleTime('departureTime', $event)"
    />
    <div v-if="!isTrip && stop.isArrivalStation" class="stop-input-time">-</div>

    <div v-if="isTrip" class="trip-stop-time">
      {{ stop.isArrivalStation ? arrivalTime : departureTime }}
    </div>
    <div v-if="isTrip" class="trip-stop-time" :style="{ color: realColor }">
      {{
        (stop.isArrivalStation
          ? stop.realArrivalTime
          : stop.realDepartureTime) === -1
          ? "?"
          : stop.isArrivalStation
          ? realArrivalTime
          : realDepartureTime
      }}
    </div>
  </div>
</template>

<script lang="ts">
import { Vue, Component, Prop } from "vue-property-decorator";
import { Util } from "../../structs/Util";
import { handleTimeText } from "./HandleTime";

@Component
export default class RouteTitle extends Vue {
  @Prop() stop: any;
  @Prop() route: any;
  @Prop() index: number;
  @Prop() candelete?: boolean;
  @Prop() canmove?: boolean;
  @Prop() isTrip?: boolean;

  get arrivalTime(): string {
    return Util.timeToString(this.stop.arrivalTime);
  }

  get departureTime(): string {
    return Util.timeToString(this.stop.departureTime);
  }

  get realArrivalTime(): string {
    return Util.timeToString(this.stop.realArrivalTime);
  }

  get realDepartureTime(): string {
    return Util.timeToString(this.stop.realDepartureTime);
  }

  get realColor(): string {
    const defVal = this.stop.isArrivalStation
      ? this.stop.arrivalTime
      : this.stop.departureTime;
    const val = Math.floor(defVal / 60);
    const defRealVal = this.stop.isArrivalStation
      ? this.stop.realArrivalTime
      : this.stop.realDepartureTime;
    const realVal = Math.floor(defRealVal / 60);
    if (defRealVal === -1) return "black";
    if (realVal < val) return "purple";
    if (realVal === val) return "green";
    if (realVal < val + 6) return "orange";
    if (realVal < val + 60) return "red";
    return "darkred";
  }

  handleTime(column: string, event: any): void {
    const { time, timeStr } = handleTimeText(event);
    event.currentTarget.value = timeStr;

    /*const stop = getStorable(this.stop.id) as RouteStop;
    if (column === "arrivalTime") {
      stop.setArrivalTime(time);
    }
    if (column === "departureTime") {
      stop.setDepartureTime(time);
    }*/
  }

  changePlatform(event: any): void {
    /*const stop = getStorable(this.stop.id) as RouteStop;
    const platform = getStorable(event.currentTarget.value) as unknown as AbstractPlatform;
    stop.setPlatform(platform);*/
  }

  addTime(): void {
    /*const stop = getStorable(this.stop.id) as RouteStop;
    stop.setExtraTimeToStation(stop.getExtraTimeToStation()+60);*/
  }

  removeTime(): void {
    /*const stop = getStorable(this.stop.id) as RouteStop;
    stop.setExtraTimeToStation(stop.getExtraTimeToStation()-60);*/
  }
}
</script>

<style scoped>
.stop:hover {
  background-color: #aaccaa;
}

.stop-circle:hover {
  cursor: pointer;
}

.stop-button-holder {
  flex-grow: 1;
  text-align: right;
  display: flex;
  justify-content: flex-end;
}

.stop-button {
  border-radius: 50%;
  background-color: #1a7829;
  color: #aaccaa;
  width: 16px;
  height: 16px;
  line-height: 14px;
  text-align: center;
  margin: -1px 1px 1px 1px;
}

.stop-button:hover {
  border-radius: 50%;
  background-color: #aaccaa;
  color: #1a7829;
  cursor: pointer;
}

.stop-input-time {
  border-radius: 2px;
  border: 1px solid #070;
  padding: 0 3px 0 3px;
  width: 35px;
  text-align: right;
}

.stop-select-platform {
  border-radius: 2px;
  border: 1px solid #070;
  padding: 0 3px 0 3px;
  width: 50px;
  font-size: 10px;
}

.trip-stop-time {
  border-radius: 2px;
  border: 1px solid #070;
  padding: 0 3px 0 3px;
  width: 35px;
  text-align: right;
  font: 400 13.3333px Arial;
  height: 13px;
}

.stop-reverse {
  font-weight: bold;
  color: orange;
}
</style>
